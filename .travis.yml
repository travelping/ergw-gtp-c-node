language: generic
sudo: required
services:
  - docker

deploy:
  provider: packagecloud
  repository: "ci"
  username: "ergw"
  token:
    secure: "CcYGWsBd27IKoBsFxXO3U4AGGNtpKDzlDim2y0O9N3ddAOcpgfFN2oQ1Wh/QgvqKa+BYgom5np4mGp6aTPPeo4gcmSxvsbPPiRhEkom5SOfJP/03MuvBsvRd8VXwEBpV9C2vnnYJTx5flgk7md7f+ZViordNLrClXPEqPB01dzht0Q/TPSA3Q6OWsxOUXA0VtbpKx2iwtViCCeXj4uuR4p6d64r698rdcENHQ7GWqwNlWwNm5pdH+6MEakm76sRyfcDGEbaujzfyXOsGj2s8XgOe7aY3BZXqq+8CEQg/iUiO4zu/e8HVLIPLxXwsbea9JyH68D0fNEHOiONCWkVzYAlU6NBHikSI3syboKgAfL6znHT6EeJqVPpFyb9gRRukbGxQBztTu/4FEpa3MPNdC9hDeeHfqOdDWK8INCGtCdHTGE6gvKd4gE5etPWm2NNYTpnOw1FFAIbPL+38xW/WrG7dNYmvsVFIWl1rhoQWb24kkL1sBMXTaSKdBbI0pEC6nUYtI2BtlzEqi/oRpBrZ6ThRGzjTli4rcKB8a28YvC5Y3sK+6ORADy6gYYWjgTTwT5nquP+Yqn9QUZg5puHdTiUEvCxYNFhsZwWBzcngvMUwTMehsuz6yM7SL6UAdoaK7zDF5v2KCZZ5HNkrFN98Rfn7/gCfHjPGxlqOgtluAx0="
  dist: "ubuntu/xenial"
  skip_cleanup: true
  package_glob: artifacts/*.deb

env:
  global:
    - BUILD_IMAGE="grundrausch3n/ergw-gtp-c-node-base"
    - DOCKER_USERNAME="grundrausch3n"
    - secure: ZDOkfRrKBYfmwY9wJTPgsQEOGhZrcpgMdz/8l3fgUqCrWy/vTgFWEA3S0WsVLF7Sa+ym1f92AX/n9PFopfS2l/QDyTDFUSxS/n6JnmQi69JLnj5btLqMpchqamUSzSaSBISz43P91iCWD+i1biR4PRD06xaBk3YshiIOeU3wAll0pG6/r4RS5576oojeU6XS5UOvBKceRoafzCAx7YAOV4JZAQqAKwCFBBDe+zx2JKpYqspHPZMt3kRX89f8Piioefgfud5Zvgg5RCwmnfe9uPt+1u0FQ6ENFk+k3lgL66IK+2fJp2/X05sCrQQQXjSUmPQ/HDhTgkPK82D5QHS7/2mWSrCRZNvD/dNXKGEWCouLhzI9YPDM10MbrJdfVCRR1WD611mi+yBsQF0YoFUe1huME9co7eXSKf3i7brI0f/V5HQyqNMnabkzsDc+PFvDVtYPvAONJHYYtAGnpPZ9vd9seHLih0PLc5fqgtPKJ1yBz1Qeu1PKxdKKUtrOKU9NDwWW/rVePpI6eLSrBj4mAzCzmRrW1w6jg4PkHe2Y1wiR7yqvdUeND4DFWwHofTMn7KKOho7Qh07M2CMpGr7NZJgsd3mReoRuLRPoGbPYf8SUsxjNWMkrBqOGm8ZqNbgoqb94PLg6Qzan5tfnqM584O2/t3bDoVoGFBaDGOw4NrE=

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y devscripts
  - docker build -t ergw -f priv/Dockerfile priv

script:
  - export SHORT_COMMIT_ID=$(git rev-parse --verify --short $TRAVIS_COMMIT)
  - debchange -m -l "+$TRAVIS_JOB_NUMBER+git$SHORT_COMMIT_ID" 'Automatically built'
  - mkdir artifacts
  - docker run -v `pwd`:/build ergw
    sh -c "
      dpkg-buildpackage -b -uc -nc && cp ../*deb artifacts
    "
  - docker build -t $BUILD_IMAGE -f docker/Dockerfile . 

after_success:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
  - docker push $BUILD_IMAGE 
  - echo "docker push done"


notifications:
  slack:
    - secure: "cXUINZF8EN0aE896uS+bB+beV4qmnhVRY1T3CXpkxWUQ/tPkvX5tWsyp87XEOUJBACxNAqn6LJoOVVP7/86CS8Ry8eBt5WJTdx3y+frUyKEz6iv2cX2ULhQ61u8YMGydTo+rMkoxyxMbHN5LM+PjmTOzDnByrjPP2u70t+93x9AZrxbgmNREHCvLV9kQEXLQbRTTbEQxOOP0+acNvanNNfpqSaprTfMmsGoetHNKmSiaMuf5iixvV47FHDfrOGeZ5jk+JgnRiHsRH7oq1rLu16gUmM3Jvj84TgdfTFiLrXFOqW26g6/fvuNwlzP2tvLTOPTJElE0/3xYVSxFoNhfA2+V77S11PwQR0rdrEmT64kNI6UKk9CuEeNdIkx0uCWz/5+ahvEaPB/nqB5/wJYZsDbipmng6zXzS7FXkY3hBbUdyoMAUtEYKPx6zg/VJZ4yUgmpvoTgY9IeR0/1Sv1RsyVu/SPWS+x7uO4TyMcVIDx07PNuW4gqfu9k7j57lMtfeu7FBjHlN8KfckLSehCN/+yKtzER5rIH1pKrdVRJLpWy4ny0Hpx4kZZKTIknZF0GRZTpcyyiNUqf+8vgpGZPQsxvT6xut7PGMockSKM8SPEhXalTBmbJRtkm7CdDxD2AgfSEuORWZE1eFMQjn2iah2uOTUd3YOddiRL6ptRL85s="

branches:
  only:
    - master
